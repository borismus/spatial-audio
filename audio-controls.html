<polymer-element name="audio-controls" attributes="contextSelector autoplay"
on-keydown="{{keyHandler}}" on-click="{{goFullscreen}}" on-touchstart="{{goFullscreen}}">
  <template>
    <style>
      #controls {
        position: absolute;
        bottom: 0;
      }
      #render {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
      }
    </style>
    <div id="render"></div>
    <div id="controls">
      <template if="{{!autoplay}}">
        <button id="play" on-click={{play}}>Play</button>
      </template>
    </div>
  </template>
  <script>
    var DELTA = 0.1;
    var ANGLE_DELTA = 0.1;

    Polymer({
      autoplay: true,

      domReady: function() {
        // Handle keyboard input.
        this.tabIndex = 0;
        this.focus();
        window.addEventListener('resize', this.onResize.bind(this));

        this.audioScene = new AudioScene(this.contextSelector);
        this.$.render.appendChild(this.audioScene.renderer.domElement);
        this.audioScene.render();

        if (this.autoplay) {
          this.autoplayTimer = setInterval(this.tryAutoplay.bind(this), 500);
        }
      },

      play: function() {
        var context3d = document.querySelector(this.contextSelector);
        context3d.play();
      },

      keyHandler: function(event, detail, sender) {
        var context3d = document.querySelector(this.contextSelector);
        var observer = context3d.querySelector('audio-observer');
        var handled = false;

        // Keyboard based movement.
        switch (event.keyCode) {
          case 37: // Left
            observer.position.x -= DELTA;
            handled = true;
            break;
          case 38: // Up
            observer.position.y += DELTA;
            handled = true;
            break;
          case 39: // Right
            observer.position.x += DELTA;
            handled = true;
            break;
          case 40: // Down
            observer.position.y -= DELTA;
            handled = true;
            break;
          case 188: // Comma (,)
            observer.turn(ANGLE_DELTA);
            handled = true;
            break;
          case 190: // Period (.)
            observer.turn(-ANGLE_DELTA);
            handled = true;
            break;
        }
        if (handled) {
          event.preventDefault();
        } else {
          console.log('Ignoring key', event.keyCode);
        }
      },

      onResize: function() {
        this.audioScene.onResize();
      },

      tryAutoplay: function() {
        var context3d = document.querySelector(this.contextSelector);
        var result = context3d.play();
        if (result) {
          clearInterval(this.autoplayTimer);
        } else {
          console.log('failed to autoplay');
        }
      },

      goFullscreen: function() {
        var container = this.$.render;
        if (container.requestFullscreen) {
          container.requestFullscreen();
          } else if (container.msRequestFullscreen) {
          container.msRequestFullscreen();
          } else if (container.mozRequestFullScreen) {
          container.mozRequestFullScreen();
          } else if (container.webkitRequestFullscreen) {
          container.webkitRequestFullscreen();
        }
      }

    });
  </script>
</polymer-element>
